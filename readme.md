# TypeScript, REST ja GraphQL

T√§ss√§ teht√§v√§ss√§ harjoitellaan HTTP-rajapintojen hy√∂dynt√§mist√§ TypeScript-kielell√§ Node.js-ymp√§rist√∂ss√§.

Teht√§v√§ on kaksiosainen:

1. Ensimm√§isess√§ osassa sinun tulee hakea k√§ytt√§j√§n antamaa paikan nime√§ vastaavat sijaintitiedot [Digitransit-palvelun rajapinnasta](https://digitransit.fi/en/developers/apis/2-geocoding-api/address-search/). T√§m√§ osa testataan valmiilla Jest-yksikk√∂testeill√§.

2. Toisessa osassa sinun tulee hy√∂dynt√§√§ [reittioppaan](https://www.hsl.fi/) taustalla toimivaa [GraphQL-reitityspalvelua](https://digitransit.fi/en/developers/apis/1-routing-api/0-graphql/) etsi√§ksesi reitin kahden k√§ytt√§j√§n m√§√§rittelem√§n paikan v√§lill√§.

üí° Voit toteuttaa halutessasi ratkaisusi my√∂s **Pythonilla**, mutta t√§ll√∂in joudut soveltamaan teht√§v√§nantoa varsin itsen√§isesti. Hyv√§ksy Teamsissa teht√§v√§st√§ Python-versio ja toteuta ohjelmasi siten, ett√§ se voidaan suorittaa esim. komennolla `python3 route.py "helsinki-vantaa lentoasema" "suomenlinna"`. Mik√§li k√§yt√§t apuna pip-paketteja, m√§√§rittele projektiisi [`requirements.txt`-tiedosto](https://pip.pypa.io/en/stable/user_guide/#requirements-files), jonka avulla n√§m√§ paketit asennetaan my√∂s testausymp√§rist√∂√∂n.


## Mik√§ on GraphQL?

GraphQL-rajapintoihin tutustumiseksi suosittelemme seuraavia kahta videota:

[**GraphQL Explained in 100 Seconds**](https://www.youtube.com/watch?v=eIQh02xuVw4) by Fireship *2:22*


[**GraphQL Client Tutorial With Fetch**](https://www.youtube.com/watch?v=0ZJI4cBS4JM) by Web Dev Simplified *15:37*

Lis√§ksi ennen teht√§v√§n toisen osan aloitusta suosittelemme lukemaan Digitransitin [GraphQL](https://digitransit.fi/en/developers/apis/1-routing-api/0-graphql)- sek√§ [GraphiQL](https://digitransit.fi/en/developers/apis/1-routing-api/1-graphiql/)-sivut.


## API-avaimet ja tunnistautuminen üîê

Digitransit-rajapinnat vaativat 3.4.2023 alkaen tunnistautumista API-avainten avulla. **Siihen asti teht√§v√§ss√§ ei tarvitse huolehtia rekister√∂itymisest√§ eik√§ API-tunnuksista.**

Siirtym√§ajan j√§lkeen API-avain on v√§ltt√§m√§t√∂n. Palveluun rekister√∂ityminen onnistuu osoitteessa https://portal-api.digitransit.fi/. Rekister√∂innin j√§lkeen voit "tilata" itsellesi "Digitransit developer API"-palvelun "Products"-v√§lilehdell√§. Tilauksen j√§lkeen l√∂yd√§t API-avaimesi "Profile"-v√§lilehdelt√§.

Tunnistautuminen onnistuu koodissa yksinkertaisesti. Sinun tulee vain lis√§t√§ jokaiseen HTTP-pyynt√∂√∂n `digitransit-subscription-key`-parametri tai "header":

> *"An API key can be included either as a URL parameter or as a header. The parameter and the header name are both `digitransit-subscription-key` and the value should be the key. "*
>
> https://digitransit.fi/en/developers/api-registration/

√Ñl√§ tallenna API-avaintasi suoraan l√§hdekoodiin, √§l√§k√§ lis√§√§ sit√§ versionhallintaan. Sen sijaan k√§yt√§ m√§√§rittele API-avainta varten [ymp√§rist√∂muuttuja](https://www.google.com/search?q=how+to+set+an+environment+variable) ja anna sille nimeksi `DIGITRANSIT_API_KEY`. T√§m√§n j√§lkeen API-avainta voidaan k√§ytt√§√§ koodissa esim. seuraavasti:

```ts
let apiKey = process.env['DIGITRANSIT_API_KEY'];
```

[Tarvittaessa voit k√§ytt√§√§ apuna my√∂s `.env`-tiedostoa](https://www.npmjs.com/package/dotenv), jota ei tule lis√§t√§ versionhallintaan.

API-avainta tarvitaan my√∂s GitHub classroom -palvelussa teht√§v√§√§ tarkastettaessa. Tarkastusymp√§rist√∂ss√§ on valmiiksi saatavilla API-tunnus `DIGITRANSIT_API_KEY`-ymp√§rist√∂muuttujassa, joten on t√§rke√§√§, ett√§ k√§yt√§t omassa ymp√§rist√∂ss√§si saman nimist√§ muuttujaa.


## Riippuvuuksien asentaminen üì¶

Aloita asentamalla projektin riippuvuudet, jotka on m√§√§ritelty `package.json`-tiedostossa:

```sh
$ npm install
```

Riippuvuudet sis√§lt√§v√§t sek√§ [TypeScript-kielen](https://www.npmjs.com/package/typescript), [Jest-testausty√∂kalun](https://www.npmjs.com/package/jest) ett√§ [`ts-node`](https://www.npmjs.com/package/ts-node)- ja [`ts-jest`](https://www.npmjs.com/package/ts-jest)-paketit TypeScript-kielisen koodin ja testien suorittamiseksi Node.js:ll√§.

Lis√§ksi riippuvuuksista l√∂ytyy [`node-fetch`](https://www.npmjs.com/package/node-fetch), joka mahdollistaa selaimista tutun `fetch`-funktion hy√∂dynt√§misen REST-rajapinnan kutsumiseksi. Node.js:n [versiosta 18 alkaen](https://nodejs.org/dist/latest/docs/api/globals.html#fetch) `fetch`-funktio kuuluu osaksi standardikirjastoa, eik√§ vaadi en√§√§ erillist√§ asennusta.


## Osa 1: Perinteinen JSON-rajapinta (2p)

T√§ss√§ osassa sinun tulee toteuttaa funktio, joka ottaa parametrinaan paikan nimen merkkijonona, esimerkiksi "suomenlinna". Funktion tulee palauttaa annettua hakutermi√§ vastaavat sijaintitiedot hy√∂dynt√§en Digitransit-palvelun [Geocoding API:a](https://digitransit.fi/en/developers/apis/2-geocoding-api/):

> *"An address is matched to its corresponding geographic coordinates and in the simplest search, you can provide only one parameter, the text you want to match in any part of the location details."*
>
> https://digitransit.fi/en/developers/apis/2-geocoding-api/address-search/

Funktio tulee toteuttaa [addressSearch.ts](./src/addressSearch.ts)-tiedostoon, jossa l√∂yd√§t valmiin pohjan `addressSearch`-funktiolle. Funktio testataan valmiilla [automaattisilla testeill√§](./src/addressSearch.test.ts), joten et saa muuttaa funktion nime√§ etk√§ siihen liittyvi√§ parametreja tai tyyppej√§.

Funktion toteuttamiseksi sinun tulee tutustua [address search -rajapinnan dokumentaatioon](https://digitransit.fi/en/developers/apis/2-geocoding-api/address-search/).

Rajapinta vastaa pyynt√∂ihin JSON-muodossa ja vastausten rakenne on kuvattu kattavasti dokumentaatiossa. Oman funktiosi tulee noudattaa t√§t√§ samaa rakennetta ja palauttaa [`AddressSearchResponse`](./src/types/GeocodingApi.ts)-tyyppinen olio. Tarvitsemasi TypeScript-tyyppi l√∂ytyy valmiina [src/types/GeocodingApi.ts](./src/types/GeocodingApi.ts)-tiedostosta.

Suosittelemme kokeilemaan rajapintaa my√∂s selaimen kautta, esimerkiksi seuraavalla osoitteella:

```
https://api.digitransit.fi/geocoding/v1/search?text=kamppi&size=3
```

Huomaa, ett√§ rajapinnan vastaus sis√§lt√§√§ huomattavasti enemm√§n tietoa kuin mit√§ teht√§v√§ss√§ tarvitsemme. Omassa sovelluksessamme tarvitsemme vain `features`-taulukkoa, joka sis√§lt√§√§ varsinaiset l√∂ydetyt sijaintitiedot.


### Fetch-funktio

Tiedostossa on valmiiksi k√§yt√∂ss√§ [`fetch`-funktio](https://www.npmjs.com/package/node-fetch), jonka avulla voit tehd√§ tarvittavan HTTP-pyynn√∂n.

Fetch-funktio on *asynkroninen* joten funktiossa t√§ytyy hy√∂dynt√§√§ Promise-objekteja tai `async`- ja `await`-avainsanoja.


### Hakusanan enkoodaus

Huomaa, ett√§ funktiolle annettava hakusana saattaa sis√§lt√§√§ erikoismerkkej√§, jotka joko eiv√§t ole sallittuja HTTP-parametreissa tai jotka muuttavat pyynn√∂n merkityst√§. Et voi siis asettaa hakusanaa suoraan osaksi URL-osoitetta, vaan se tulee [enkoodata](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent), esim. `'t√∂√∂l√∂nlahti 1'` &rarr; `'t%C3%B6%C3%B6l%C3%B6nlahti%201'`.


### Virheiden k√§sittely

`fetch`-funktio heitt√§√§ poikkeuksen, mik√§li esimerkiksi sille annettu data on virheellist√§ tai pyynt√∂√∂n ei saada lainkaan vastausta. `fetch` ei kuitenkaan heit√§ poikkeusta, mik√§li vastaus saadaan, vaikka vastauksen HTTP-statuskoodi viittaisi virheeseen kuten `400` tai `500`.

`addressSearch`-funktiosi tulee varmistaa, ett√§ saatu vastaus on "OK" ja mik√§li se ei ole, funktion tulee heitt√§√§ poikkeus.


### Teht√§v√§n testaaminen

Teht√§v√§n yksikk√∂testit suoritetaan [Jest-ty√∂kalun](https://jestjs.io/) avulla komennolla `npm test`:

```sh
$ npm test
```


## Osa 2: GraphQL-rajapinta (3p)

Teht√§v√§n toisessa osassa tarkoituksena on hy√∂dynt√§√§ edell√§ toteutettua osoitehakua sek√§ Routing API:a ja toteuttaa oma reittiopasta vastaava komentorivik√§ytt√∂liittym√§.

> *"Routing API provides a way to plan itineraries and query public transportation related information about stops and timetables using GraphQL."*
>
> https://digitransit.fi/en/developers/apis/1-routing-api/

Voit toteuttaa k√§ytt√∂liittym√§si varsin vapaasti omien mieltymystesi mukaiseksi. Ohjelma on kuitenkin automaattisen arvioinnin vuoksi voitava suorittaa esim. komennolla:

```sh
$ npm start "helsinki-vantaa lentoasema" "suomenlinna"
```

Seuraavassa esimerkiss√§ k√§ytt√§j√§n sy√∂tt√§m√§t sijaintitiedot annetaan ensin `addressSearch`-funktiolle ja n√§it√§ sijaintitietoja k√§ytet√§√§n Routing API:n kanssa reittiehdotusten n√§ytt√§miseksi:

```
$ npm start "helsinki-vantaa lentoasema" "suomenlinna"

> start
> ts-node src/index.ts helsinki-vantaa lentoasema suomenlinna

From: Helsinki-Vantaan lentoasema, Lentoasemantie 1, Vantaa
To:   Suomenlinna, Helsinki

### 7:42:33‚ÄØAM - 8:55:25‚ÄØAM, 72 minutes ###

üö∂‚Äç  Origin -> Lentoasema
7:42:33‚ÄØAM - 7:52:00‚ÄØAM, 9 minutes

üöÜ P Lentoasema -> Helsinki
7:52:00‚ÄØAM - 8:21:00‚ÄØAM, 29 minutes

üö∂‚Äç  Helsinki -> Kauppatori
8:21:00‚ÄØAM - 8:37:22‚ÄØAM, 16 minutes

üö¢ 19 Kauppatori -> Suomenlinna, p√§√§lait
8:40:00‚ÄØAM - 8:55:00‚ÄØAM, 15 minutes

üö∂‚Äç  Suomenlinna, p√§√§lait -> Destination
8:55:00‚ÄØAM - 8:55:25‚ÄØAM, 0 minutes
```

`npm start` aloittaa ohjelman suorituksen tiedostosta [src/index.ts](./src/index.ts), mutta sinun kannattaa todenn√§k√∂isesti jakaa ohjelmaasi pienempiin osiin ja luoda my√∂s uusia tiedostoja.

Oman sovelluksesi ei tarvitse tulostaa kaikkia edell√§ esitettyj√§ tietoja. Esimerkiksi kellonajat, matkojen kestot ja emoji-merkit ovat teht√§v√§n n√§k√∂kulmasta ylim√§√§r√§isi√§. Automaattisen arvioinnin vuoksi matkaehdotuksen jokaiselle osuudelle ("leg") tulee kuitenkin tulostaa v√§hint√§√§n l√§ht√∂paikan ja m√§√§r√§np√§√§n nimet (`leg.from.name` ja `leg.to.name`).

Voit halutessasi tulostaa vain yhden tai useampia vaihtoehtoisia reittiehdotuksia.

### GraphiQL

Suosittelemme hy√∂dynt√§m√§√§n teht√§v√§√§ tehdess√§si Digitransitin GraphiQL-palvelua. GraphiQL:n avulla kyselyiden muodostaminen ja suorittaminen on suoraviivaista. Se osaa my√∂s t√§ydent√§√§ automaattisesti sallitut attribuutit kullekin tietotyypille.

> *"It is highly recommended to use GraphiQL when familiarizing yourself with the Routing API."*
>
> *"[GraphiQL](https://github.com/graphql/graphiql) is a simple UI for making queries. You can use it both to run queries and to explore the GraphQL schema."*
>
> https://digitransit.fi/en/developers/apis/1-routing-api/1-graphiql/

Voit kokeilla [yll√§ esitetyn k√§ytt√∂liittym√§n taustalla olevaa kysely√§ GraphiQL-k√§ytt√∂liittym√§ss√§](https://api.digitransit.fi/graphiql/hsl?query=%257B%250A%2520%2520%2520%2520plan%28%250A%2520%2520%2520%2520%2520%2520%2520%2520from%253A%2520%257B%2520lat%253A%252060.318933%252C%2520lon%253A%252024.968296%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520to%253A%2520%257B%2520lat%253A%252060.149087%252C%2520lon%253A%252024.984228%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520numItineraries%253A%25201%250A%2520%2520%2520%2520%29%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520itineraries%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520startTime%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520endTime%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520walkTime%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520walkDistance%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520legs%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520from%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520name%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520lat%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520lon%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520to%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520name%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520lat%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520lon%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520startTime%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520endTime%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520mode%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520duration%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520distance%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520route%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520shortName%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520longName%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%257D%250A%257D):

```graphql
{
    plan(
        from: { lat: 60.318933, lon: 24.968296 }
        to: { lat: 60.149087, lon: 24.984228 }
        numItineraries: 1
    ) {
        itineraries {
            startTime
            endTime
            walkTime
            walkDistance
            legs {
                from {
                    name
                    lat
                    lon
                }
                to {
                    name
                    lat
                    lon
                }
                startTime
                endTime
                mode
                duration
                distance
                route {
                    shortName
                    longName
                }
            }
        }
    }
}
```

Yll√§ olevat koordinaattipisteet vastaavat paikkoja "Helsinki-Vantaan lentoasema, Lentoasemantie 1, Vantaa" sek√§ "Suomenlinna, Helsinki". K√§yt√§ teht√§v√§n 1. osassa toteuttamaasi `addressSearch`-funktiota k√§ytt√§j√§n antamien paikkojen sijaintitietojen selvitt√§miseksi.


### Reititysrajapinta

Teht√§v√§n ratkaisemiseksi sinun tulee hy√∂dynt√§√§ Digitransit-palvelun dokumentaatiota https://digitransit.fi/en/developers/apis/1-routing-api/. Dokumentaatiosta l√∂yd√§t esimerkiksi tiedot rajapinnan URL-osoitteista sek√§ sallituista HTTP-metodeista ja vaadituista HTTP-headereista.

GraphQL-rajapinnan k√§ytt√§minen voi aluksi vaikuttaa ylivoimaiselta, mutta palvelun dokumentaatio sis√§lt√§√§ lukuisia esimerkkej√§ sek√§ [testik√§ytt√∂liittym√§n](https://api.digitransit.fi/graphiql/hsl), joiden avulla p√§√§set toivottavasti hyvin alkuun. Suosittelemme my√∂s katsomaan t√§m√§n sivun yl√§osassa esitetyt videot ja keskustelemaan mahdollisista haasteista Teamsissa.


### Fetch-funktio

GraphQL-rajapinnan k√§ytt√§miseksi on olemassa lukuisia kirjastoja, jotka voivat tehd√§ t√§st√§ teht√§v√§st√§ helpomman tai huonossa tapauksessa haastavamman.

Yksinkertaisimmillaan rajapintaa voidaan k√§ytt√§√§ siten, ett√§ teet `fetch`-funktiolla kutsun, jossa GraphQL-haku on merkkijonona pyynn√∂n rungossa (body):

```ts
let response = await fetch('https://api.digitransit.fi/routing/v1/routers/hsl/index/graphql', {
    headers: { 'Content-Type': 'application/graphql' },
    method: 'POST',
    body: '{ plan(...'
});
```

Rajapinta palauttaa vastauksen JSON-muodossa, joten voit k√§ytt√§√§ tuttuun tapaan `json()`-metodia sen parsimiseksi:

```ts
let routing: RoutingResponse = await response.json();
```

### Tietotyypit

GraphQL-pyynn√∂ss√§ vastauksen rakenne riippuu rajapintaan tehdyst√§ hausta. T√§m√§n teht√§v√§n kannalta oleellisimmat tietotyypit ovat `Plan`, `Itinerary`, `Leg` sek√§ `Place`. N√§m√§ tietotyypit on dokumentoitu kattavasti Digitransit-palvelun [GraphiQL-palvelussa](https://api.digitransit.fi/graphiql/hsl). Suosittelemme my√∂s tutustumaan lyhyeen ohjeistukseen siit√§, miten t√§t√§ dokumentaatiota on tarkoitus k√§ytt√§√§: [reading schema docs](https://digitransit.fi/en/developers/apis/1-routing-api/1-graphiql/#reading-schema-docs).

Voit halutessasi hy√∂dynt√§√§ tiedostossa [src/types/RoutingApi.ts](./src/types/RoutingApi.ts) olevia valmiita tyyppej√§, mutta se ei ole v√§ltt√§m√§t√∂nt√§.


## Lisenssit ‚öñ

T√§m√§n teht√§v√§n on kehitt√§nyt Teemu Havulinna ja se on lisensoitu [Creative Commons BY-NC-SA -lisenssill√§](https://creativecommons.org/licenses/by-nc-sa/4.0/).


### Digitransit

> *"Digitransit Platform is an open source journey planning solution that combines several open source components into a modern, highly available route planning service. Route planning algorithms and APIs are provided by Open Trip Planner (OTP). OTP is a great solution for general route planning but in order to provide top-notch journey planning other components such as Mobile friendly user interface, Map tile serving, Geocoding, and various data conversion tools are needed. Digitransit platform provides these tools."*
>
> https://digitransit.fi/en/developers/